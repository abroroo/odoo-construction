<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Warehouse Stock Tree View -->
    <record id="view_warehouse_stock_tree" model="ir.ui.view">
        <field name="name">warehouse.stock.tree</field>
        <field name="model">construction.warehouse.stock</field>
        <field name="arch" type="xml">
            <tree string="Warehouse Stock" decoration-danger="stock_status == 'out'" decoration-warning="stock_status == 'low'" decoration-success="stock_status == 'ok'">
                <field name="warehouse_id"/>
                <field name="project_id"/>
                <field name="material_id"/>
                <field name="quantity"/>
                <field name="unit_of_measure"/>
                <field name="reserved_quantity"/>
                <field name="available_quantity"/>
                <field name="stock_status" widget="badge" decoration-danger="stock_status == 'out'" decoration-warning="stock_status == 'low'" decoration-success="stock_status == 'ok'"/>
                <field name="storage_location"/>
                <field name="unit_cost"/>
                <field name="total_value" sum="Total Value"/>
                <field name="last_receipt_date"/>
                <button name="action_receive_material" type="object" icon="fa-plus" title="Receive Material"/>
                <button name="action_consume_material" type="object" icon="fa-minus" title="Consume Material"/>
            </tree>
        </field>
    </record>

    <!-- Warehouse Stock Form View -->
    <record id="view_warehouse_stock_form" model="ir.ui.view">
        <field name="name">warehouse.stock.form</field>
        <field name="model">construction.warehouse.stock</field>
        <field name="arch" type="xml">
            <form string="Warehouse Stock" create="false" edit="false">
                <header>
                    <button name="action_receive_material" string="Receive Material" type="object" class="btn-primary"/>
                    <button name="action_consume_material" string="Consume Material" type="object" class="btn-secondary"/>
                    <field name="stock_status" widget="statusbar"/>
                </header>
                <sheet>
                    <div class="oe_title">
                        <h1>
                            <field name="material_id" readonly="1"/>
                        </h1>
                        <h3>
                            <field name="warehouse_id" readonly="1"/>
                        </h3>
                    </div>

                    <group>
                        <group string="Stock Information">
                            <field name="quantity" readonly="1"/>
                            <field name="unit_of_measure" readonly="1"/>
                            <field name="reserved_quantity" readonly="1"/>
                            <field name="available_quantity" readonly="1"/>
                        </group>
                        <group string="Costing">
                            <field name="unit_cost" readonly="1"/>
                            <field name="total_value" readonly="1"/>
                            <field name="minimum_quantity"/>
                        </group>
                    </group>

                    <group>
                        <group string="Storage">
                            <field name="storage_location"/>
                        </group>
                        <group string="Last Activity">
                            <field name="last_receipt_date" readonly="1"/>
                            <field name="last_consumption_date" readonly="1"/>
                        </group>
                    </group>

                    <group string="Storage Notes">
                        <field name="storage_notes" nolabel="1" placeholder="Special storage requirements..."/>
                    </group>

                    <notebook>
                        <page string="Stock Movements">
                            <group>
                                <group string="Recent Receipts">
                                    <field name="receipt_ids" nolabel="1" readonly="1">
                                        <tree string="Receipts">
                                            <field name="receipt_date"/>
                                            <field name="quantity"/>
                                            <field name="supplier_id"/>
                                            <field name="unit_cost"/>
                                            <field name="receipt_status"/>
                                        </tree>
                                    </field>
                                </group>
                                <group string="Recent Consumptions">
                                    <field name="consumption_ids" nolabel="1" readonly="1">
                                        <tree string="Consumptions">
                                            <field name="consumption_date"/>
                                            <field name="quantity"/>
                                            <field name="consumed_by_id"/>
                                            <field name="consumption_status"/>
                                        </tree>
                                    </field>
                                </group>
                            </group>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>

    <!-- Warehouse Stock Kanban View -->
    <record id="view_warehouse_stock_kanban" model="ir.ui.view">
        <field name="name">warehouse.stock.kanban</field>
        <field name="model">construction.warehouse.stock</field>
        <field name="arch" type="xml">
            <kanban class="o_kanban_mobile">
                <field name="id"/>
                <field name="material_id"/>
                <field name="warehouse_id"/>
                <field name="quantity"/>
                <field name="available_quantity"/>
                <field name="unit_of_measure"/>
                <field name="stock_status"/>
                <field name="total_value"/>
                <field name="storage_location"/>
                <templates>
                    <t t-name="kanban-box">
                        <div class="oe_kanban_card oe_kanban_global_click" t-att-class="record.stock_status.raw_value === 'out' ? 'border-danger' : record.stock_status.raw_value === 'low' ? 'border-warning' : 'border-success'">
                            <div class="o_kanban_record_top mb8">
                                <div class="o_kanban_record_headings">
                                    <strong class="o_kanban_record_title">
                                        <t t-esc="record.material_id.value"/>
                                    </strong>
                                    <br/>
                                    <small class="text-muted">
                                        <t t-esc="record.warehouse_id.value"/>
                                    </small>
                                </div>
                                <div class="o_kanban_record_top_right">
                                    <span class="badge" t-att-class="record.stock_status.raw_value === 'out' ? 'badge-danger' : record.stock_status.raw_value === 'low' ? 'badge-warning' : 'badge-success'">
                                        <t t-esc="record.stock_status.value"/>
                                    </span>
                                </div>
                            </div>
                            <div class="o_kanban_record_body">
                                <div class="row mb4">
                                    <div class="col-6">
                                        <strong>Available:</strong>
                                    </div>
                                    <div class="col-6 text-right">
                                        <strong><t t-esc="record.available_quantity.value"/> <t t-esc="record.unit_of_measure.value"/></strong>
                                    </div>
                                </div>
                                <div class="row mb4">
                                    <div class="col-6">
                                        <strong>Total Stock:</strong>
                                    </div>
                                    <div class="col-6 text-right">
                                        <t t-esc="record.quantity.value"/> <t t-esc="record.unit_of_measure.value"/>
                                    </div>
                                </div>
                                <div class="row mb4">
                                    <div class="col-6">
                                        <strong>Value:</strong>
                                    </div>
                                    <div class="col-6 text-right">
                                        $<t t-esc="record.total_value.value"/>
                                    </div>
                                </div>
                                <div class="text-muted" t-if="record.storage_location.value">
                                    <i class="fa fa-map-marker"/> <t t-esc="record.storage_location.value"/>
                                </div>
                            </div>
                            <div class="o_kanban_record_bottom mt8">
                                <div class="oe_kanban_bottom_left">
                                    <button name="action_receive_material" type="object" class="btn btn-sm btn-success">
                                        <i class="fa fa-plus"/> Receive
                                    </button>
                                </div>
                                <div class="oe_kanban_bottom_right">
                                    <button name="action_consume_material" type="object" class="btn btn-sm btn-primary">
                                        <i class="fa fa-minus"/> Consume
                                    </button>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- Search View -->
    <record id="view_warehouse_stock_search" model="ir.ui.view">
        <field name="name">warehouse.stock.search</field>
        <field name="model">construction.warehouse.stock</field>
        <field name="arch" type="xml">
            <search string="Search Warehouse Stock">
                <field name="material_id" string="Material"/>
                <field name="warehouse_id" string="Warehouse"/>
                <field name="project_id" string="Project"/>

                <filter string="In Stock" name="filter_in_stock" domain="[('stock_status', '=', 'ok')]"/>
                <filter string="Low Stock" name="filter_low_stock" domain="[('stock_status', '=', 'low')]"/>
                <filter string="Out of Stock" name="filter_out_stock" domain="[('stock_status', '=', 'out')]"/>

                <separator/>
                <filter string="Has Available Quantity" name="filter_available" domain="[('available_quantity', '>', 0)]"/>

                <group expand="0" string="Group By">
                    <filter string="Warehouse" name="group_warehouse" context="{'group_by': 'warehouse_id'}"/>
                    <filter string="Project" name="group_project" context="{'group_by': 'project_id'}"/>
                    <filter string="Material" name="group_material" context="{'group_by': 'material_id'}"/>
                    <filter string="Stock Status" name="group_status" context="{'group_by': 'stock_status'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- Actions -->
    <record id="action_warehouse_stock" model="ir.actions.act_window">
        <field name="name">Warehouse Stock</field>
        <field name="res_model">construction.warehouse.stock</field>
        <field name="view_mode">kanban,tree,form</field>
        <field name="context">{'search_default_filter_available': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No stock items found!
            </p>
            <p>
                Stock items are automatically created when materials are received in warehouses.
                Start by receiving materials to build up your inventory.
            </p>
        </field>
    </record>

    <!-- Site Manager's Warehouse Stock (filtered to own projects) -->
    <record id="action_my_warehouse_stock" model="ir.actions.act_window">
        <field name="name">My Warehouse Stock</field>
        <field name="res_model">construction.warehouse.stock</field>
        <field name="view_mode">kanban,tree,form</field>
        <field name="domain">[('project_id.user_id', '=', uid)]</field>
        <field name="context">{'search_default_filter_available': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No materials in your project warehouses!
            </p>
            <p>
                Materials will appear here once suppliers deliver them to your project warehouses.
            </p>
        </field>
    </record>
</odoo>